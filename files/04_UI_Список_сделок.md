# Задание 4: UI — Страница списка сделок

## Контекст
Проект Cyclops Dashboard (Next.js 14 App Router). Типы, API и хуки уже созданы. Нужно реализовать страницу списка сделок по аналогии с существующими разделами (payments, beneficiaries).

## Входные данные
- Хуки: `hooks/useDeals.ts`
- Утилиты: `lib/utils/deals.ts`
- Типы: `types/cyclops/deals.ts`
- Примеры UI: `app/(dashboard)/payments/`, `app/(dashboard)/beneficiaries/`

## Задача
Создать страницу списка сделок: `app/(dashboard)/deals/page.tsx`

## Требования к UI

### Шапка страницы
- Заголовок "Сделки"
- Кнопка "Создать сделку" → `/deals/create`

### Фильтры (над таблицей)
- **Статус** — Select с вариантами:
  - Все
  - Новая (new)
  - В процессе (in_process)
  - Частично исполнена (partial)
  - Завершена (closed)
  - Отменена (rejected)
  - Требует коррекции (correction)
  
- **Внешний ключ** — текстовое поле (ext_key)

- **Дата создания** — диапазон дат (created_date_from, created_date_to)

- Кнопка "Применить фильтры"
- Кнопка "Сбросить"

### Таблица сделок

| Колонка | Поле | Описание |
|---------|------|----------|
| ID | id | Клик → переход на `/deals/[id]` |
| Внешний ключ | ext_key | Если есть |
| Сумма | amount | Форматирование: `12 345,00 ₽` |
| Статус | status | Badge с цветом |
| Создана | created_at | `DD.MM.YYYY HH:mm` |
| Обновлена | updated_at | `DD.MM.YYYY HH:mm` |

### Цвета статусов (Badge)
```
new          → серый (bg-gray-100)
in_process   → синий (bg-blue-100)
partial      → жёлтый (bg-yellow-100)
closed       → зелёный (bg-green-100)
rejected     → красный (bg-red-100)
correction   → оранжевый (bg-orange-100)
canceled_by_platform → красный (bg-red-100)
```

### Пагинация
- Показывать: "Показано X из Y"
- Кнопки: Назад / Вперёд
- Выбор количества на странице: 20 / 50 / 100

### Состояния
- **Загрузка** — скелетон или спиннер
- **Ошибка** — сообщение с кнопкой "Повторить"
- **Пустой список** — "Сделки не найдены"

## Реализация

### Файл: `app/(dashboard)/deals/page.tsx`

```tsx
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useDeals } from '@/hooks/useDeals';
import { 
  DEAL_STATUS_LABELS, 
  DEAL_STATUS_COLORS, 
  formatAmount, 
  formatDate 
} from '@/lib/utils/deals';
import type { DealStatus, ListDealsParams } from '@/types/cyclops/deals';

// Компонент Badge для статуса
function StatusBadge({ status }: { status: DealStatus }) {
  return (
    <span className={`px-2 py-1 rounded-full text-xs font-medium ${DEAL_STATUS_COLORS[status]}`}>
      {DEAL_STATUS_LABELS[status]}
    </span>
  );
}

// Компонент фильтров
function DealsFilters({ 
  filters, 
  onApply, 
  onReset 
}: { 
  filters: ListDealsParams['filters'];
  onApply: (filters: ListDealsParams['filters']) => void;
  onReset: () => void;
}) {
  const [localFilters, setLocalFilters] = useState(filters || {});

  const handleApply = () => {
    onApply(localFilters);
  };

  const handleReset = () => {
    setLocalFilters({});
    onReset();
  };

  return (
    <div className="bg-white p-4 rounded-lg shadow mb-4">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        {/* Статус */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Статус
          </label>
          <select
            value={localFilters.status || ''}
            onChange={(e) => setLocalFilters({ 
              ...localFilters, 
              status: e.target.value as DealStatus || undefined 
            })}
            className="w-full border rounded-md px-3 py-2"
          >
            <option value="">Все</option>
            <option value="new">Новая</option>
            <option value="in_process">В процессе</option>
            <option value="partial">Частично исполнена</option>
            <option value="closed">Завершена</option>
            <option value="rejected">Отменена</option>
            <option value="correction">Требует коррекции</option>
          </select>
        </div>

        {/* Внешний ключ */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Внешний ключ
          </label>
          <input
            type="text"
            value={localFilters.ext_key || ''}
            onChange={(e) => setLocalFilters({ 
              ...localFilters, 
              ext_key: e.target.value || undefined 
            })}
            placeholder="ext_key"
            className="w-full border rounded-md px-3 py-2"
          />
        </div>

        {/* Дата с */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Создана с
          </label>
          <input
            type="date"
            value={localFilters.created_date_from || ''}
            onChange={(e) => setLocalFilters({ 
              ...localFilters, 
              created_date_from: e.target.value || undefined 
            })}
            className="w-full border rounded-md px-3 py-2"
          />
        </div>

        {/* Дата по */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Создана по
          </label>
          <input
            type="date"
            value={localFilters.created_date_to || ''}
            onChange={(e) => setLocalFilters({ 
              ...localFilters, 
              created_date_to: e.target.value || undefined 
            })}
            className="w-full border rounded-md px-3 py-2"
          />
        </div>
      </div>

      <div className="flex gap-2 mt-4">
        <button
          onClick={handleApply}
          className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
        >
          Применить
        </button>
        <button
          onClick={handleReset}
          className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"
        >
          Сбросить
        </button>
      </div>
    </div>
  );
}

// Основная страница
export default function DealsPage() {
  const router = useRouter();
  const [page, setPage] = useState(1);
  const [perPage, setPerPage] = useState(50);
  const [filters, setFilters] = useState<ListDealsParams['filters']>({});

  const { deals, loading, error, meta, fetchDeals } = useDeals({ autoFetch: false });

  // Загрузка при изменении параметров
  useEffect(() => {
    fetchDeals({ page, per_page: perPage, filters });
  }, [page, perPage]);

  const handleApplyFilters = (newFilters: ListDealsParams['filters']) => {
    setFilters(newFilters);
    setPage(1);
    fetchDeals({ page: 1, per_page: perPage, filters: newFilters });
  };

  const handleResetFilters = () => {
    setFilters({});
    setPage(1);
    fetchDeals({ page: 1, per_page: perPage, filters: {} });
  };

  const handleRowClick = (dealId: string) => {
    router.push(`/deals/${dealId}`);
  };

  return (
    <div className="p-6">
      {/* Шапка */}
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">Сделки</h1>
        <button
          onClick={() => router.push('/deals/create')}
          className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
        >
          Создать сделку
        </button>
      </div>

      {/* Фильтры */}
      <DealsFilters
        filters={filters}
        onApply={handleApplyFilters}
        onReset={handleResetFilters}
      />

      {/* Ошибка */}
      {error && (
        <div className="bg-red-50 text-red-600 p-4 rounded-lg mb-4">
          {error}
          <button 
            onClick={() => fetchDeals({ page, per_page: perPage, filters })}
            className="ml-4 underline"
          >
            Повторить
          </button>
        </div>
      )}

      {/* Таблица */}
      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Внешний ключ</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Сумма</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Статус</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Создана</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Обновлена</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {loading ? (
              // Скелетон загрузки
              [...Array(5)].map((_, i) => (
                <tr key={i}>
                  {[...Array(6)].map((_, j) => (
                    <td key={j} className="px-6 py-4">
                      <div className="h-4 bg-gray-200 rounded animate-pulse"></div>
                    </td>
                  ))}
                </tr>
              ))
            ) : deals.length === 0 ? (
              <tr>
                <td colSpan={6} className="px-6 py-12 text-center text-gray-500">
                  Сделки не найдены
                </td>
              </tr>
            ) : (
              deals.map((deal) => (
                <tr
                  key={deal.id}
                  onClick={() => handleRowClick(deal.id)}
                  className="hover:bg-gray-50 cursor-pointer"
                >
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-mono text-blue-600">
                    {deal.id.slice(0, 8)}...
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {deal.ext_key || '—'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    {deal.amount !== undefined ? formatAmount(deal.amount) : '—'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    {deal.status && <StatusBadge status={deal.status} />}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {deal.created_at ? formatDate(deal.created_at) : '—'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {deal.updated_at ? formatDate(deal.updated_at) : '—'}
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {/* Пагинация */}
      {meta && (
        <div className="flex justify-between items-center mt-4">
          <div className="text-sm text-gray-500">
            Показано {deals.length} из {meta.total}
          </div>
          
          <div className="flex items-center gap-4">
            <select
              value={perPage}
              onChange={(e) => {
                setPerPage(Number(e.target.value));
                setPage(1);
              }}
              className="border rounded-md px-2 py-1"
            >
              <option value={20}>20</option>
              <option value={50}>50</option>
              <option value={100}>100</option>
            </select>
            
            <div className="flex gap-2">
              <button
                onClick={() => setPage(p => Math.max(1, p - 1))}
                disabled={page === 1}
                className="px-3 py-1 border rounded-md disabled:opacity-50"
              >
                Назад
              </button>
              <span className="px-3 py-1">
                Страница {meta.currentPage}
              </span>
              <button
                onClick={() => setPage(p => p + 1)}
                disabled={deals.length < perPage}
                className="px-3 py-1 border rounded-md disabled:opacity-50"
              >
                Вперёд
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

## Ожидаемый результат

Файл `app/(dashboard)/deals/page.tsx` с:
- Таблицей сделок
- Фильтрами (статус, ext_key, даты)
- Пагинацией
- Обработкой состояний (загрузка, ошибка, пустой список)
- Навигацией на создание и детальную страницу

## Дополнительно

Добавить пункт в навигацию (`components/Sidebar.tsx`):
```tsx
{ href: '/deals', label: 'Сделки', icon: DocumentTextIcon }
```
