# Задание 1: Типы TypeScript и Zod-валидаторы для сделок

## Контекст
Ты работаешь над проектом Cyclops Dashboard (Next.js 14 + TypeScript). Нужно создать типы и валидаторы для раздела "Сделки" (Deals), который интегрируется с Cyclops API банка Точка.

## Задача
Создать два файла:
1. `types/cyclops/deals.ts` — TypeScript типы
2. `lib/validators/deals.ts` — Zod-схемы валидации

## Спецификация типов

### Статусы сделки
```typescript
type DealStatus = 'new' | 'in_process' | 'partial' | 'closed' | 'rejected' | 'correction' | 'canceled_by_platform';
```

### Типы получателей (7 типов)
- `payment_contract` — оплата по договору (счёт + БИК + ИНН)
- `commission` — комиссия площадки
- `ndfl` — бюджетный платёж (налоги)
- `ndfl_to_virtual_account` — сбор налогов на ВС
- `payment_contract_by_sbp` — СБП старый флоу
- `payment_contract_by_sbp_v2` — СБП новый флоу
- `payment_contract_to_card` — выплата на карту

### Структура плательщика
```typescript
interface DealPayer {
  virtual_account: string;  // UUID виртуального счёта
  amount: number;           // Сумма (2 знака после запятой)
  executed?: boolean | null;
  documents?: DealDocument[];
}
```

### Получатель payment_contract (основной тип)
```typescript
interface PaymentContractRecipient {
  type: 'payment_contract';
  number: number;           // Уникальный в рамках сделки
  amount: number;           // Не более 2 знаков после запятой
  account: string;          // Счёт, 20 цифр
  bank_code: string;        // БИК, 9 цифр
  name: string;             // Наименование (regex: ^[ -~№А-яёЁ\t\n\r]*$)
  inn: string;              // 10 или 12 цифр
  kpp?: string;             // 9 цифр, опционально
  purpose?: string;         // Назначение платежа
  purpose_nds?: number;     // Процент НДС
  document_number?: string; // До 6 символов
  identifier?: string;      // 1-60 символов
  code_purpose?: '1'|'2'|'3'|'4'|'5';
}
```

### Получатель commission
```typescript
interface CommissionRecipient {
  type: 'commission';
  number: number;
  amount: number;
  name: string;
  kpp?: string;
  purpose?: string;          // Полное назначение ИЛИ:
  purpose_nds?: number;      // НДС %
  purpose_type?: 'standard' | 'with_inn';
  document_number?: string;
}
```

### Получатель СБП (v1 и v2)
```typescript
interface SbpRecipient {
  type: 'payment_contract_by_sbp' | 'payment_contract_by_sbp_v2';
  number: number;
  amount: number;
  first_name: string;
  middle_name?: string;      // Если есть отчество
  last_name: string;
  phone_number: string;      // 11 символов, начинается с "7"
  bank_sbp_id: string;       // ID банка из list_bank_sbp
  purpose?: string;          // До 140 символов
  purpose_nds?: number;
  identifier?: string;
  inn?: string;              // 12 цифр, опционально
}
```

### Получатель на карту
```typescript
interface CardRecipient {
  type: 'payment_contract_to_card';
  number: number;
  amount: number;
  card_number_crypto_base64: string;  // Зашифрованный RSA OAEP номер карты
  purpose?: string;          // До 210 символов (50 для B2B)
  document_number?: string;
  identifier?: string;
  inn?: string;
}
```

### Получатель НДФЛ
```typescript
interface NdflRecipient {
  type: 'ndfl';
  number: number;
  amount: number;
  account: string;           // 20 цифр
  bank_code: string;         // 9 цифр
  inn: string;               // 10 цифр
  purpose: string;
  kbk: string;               // 20 цифр
  oktmo: string;             // 8 цифр
  base: string;              // Основание налогового платежа
  tax_fields: {
    field107?: string;       // Период оплаты
    type?: string;           // Вид платежа
    status?: string;         // Статус плательщика (01-15)
    document_date?: string;  // YYYY-MM-DD или "0"
  };
  recipient_fio?: { first_name: string; last_name: string; middle_name?: string; };
}
```

### Получатель ndfl_to_virtual_account
```typescript
interface NdflToVirtualAccountRecipient {
  type: 'ndfl_to_virtual_account';
  number: number;
  amount: number;
  virtual_account: string;   // ВС типа for_ndfl
}
```

### Информация о получателе (из get_deal)
```typescript
interface DealRecipientInfo {
  number: number;
  amount: number;
  status: 'new' | 'in_process' | 'reject' | 'success' | 'old';
  executed: boolean | null;
  requisites: Record<string, any>;
  type: RecipientType;
  payment?: {
    id: string;
    status: 'NEW' | 'CREATED' | 'WAIT_PAID' | 'WAIT_VERIFY' | 'WAIT_SEND' | 'PAID' | 'K2' | 'CANCELED';
    meta?: { rrn?: string; error_code?: number; code_description?: string; };
  };
  error_reason?: string;
}
```

### Сделка (полная)
```typescript
interface Deal {
  id: string;
  ext_key?: string;
  amount: number;
  status: DealStatus;
  payers: DealPayer[];
  recipients: DealRecipientInfo[];
  created_at: string;
  updated_at: string;
}
```

### Параметры запросов
```typescript
// Создание сделки
interface CreateDealParams {
  ext_key?: string;
  amount: number;
  payers: Array<{ virtual_account: string; amount: number; }>;
  recipients: DealRecipient[];  // Union всех типов получателей
}

// Список сделок
interface ListDealsParams {
  page?: number;              // По умолчанию 1
  per_page?: number;          // По умолчанию 100, макс 1000
  field_names?: Array<'amount' | 'status' | 'created_at' | 'updated_at' | 'ext_key'>;
  filters?: {
    status?: DealStatus;
    ext_key?: string;
    created_date_from?: string;   // YYYY-MM-DD
    created_date_to?: string;
    updated_at_from?: string;     // ISO datetime
    updated_at_to?: string;
  };
}

// Исполнение сделки
interface ExecuteDealParams {
  deal_id: string;
  recipients_execute?: Array<{ number: number }>;  // Для частичного исполнения
}
```

### Ответы API
```typescript
interface CreateDealResponse {
  deal_id: string;
  compliance_check_payments: Array<{
    number: number;
    approved: boolean;
    messages: Array<{ level: 'ERROR' | 'WARNING'; text: string; }>;
  }>;
}

interface ListDealsResponse {
  deals: Array<{ id: string; status?: DealStatus; amount?: number; ext_key?: string; created_at?: string; updated_at?: string; }>;
  meta: { total: number; page: { current_page: number; per_page: number; }; };
}
```

## Zod-схемы (важные правила)

### Регулярные выражения из документации
```typescript
const ALLOWED_TEXT_REGEX = /^[ -~№А-яёЁ\t\n\r]*$/;
const IDENTIFIER_REGEX = /^[0-9A-Za-zА-яЁё\t\n\r \-\/\:\-\@\[\-\`\{\-\~№]{1,60}$/;
```

### Валидация полей
- `amount` — `z.number().positive().multipleOf(0.01)`
- `account` — `z.string().length(20).regex(/^\d+$/)`
- `bank_code` — `z.string().length(9).regex(/^\d+$/)`
- `inn` — `z.string().regex(/^\d{10}$|^\d{12}$/)`
- `kpp` — `z.string().length(9).regex(/^\d+$/)`
- `phone_number` — `z.string().length(11).startsWith('7')`
- `virtual_account` — `z.string().uuid()`

## Ожидаемый результат

### Файл `types/cyclops/deals.ts`
- Все типы статусов
- Все интерфейсы получателей (7 типов)
- Union-тип DealRecipient
- Интерфейсы запросов/ответов
- Экспорт всех типов

### Файл `lib/validators/deals.ts`
- Zod-схемы для каждого типа получателя
- Схема createDealParamsSchema
- Схема listDealsParamsSchema
- Схема для фильтров
- Экспорт всех схем

## Примеры использования

```typescript
// Валидация создания сделки
import { createDealParamsSchema } from '@/lib/validators/deals';

const data = {
  amount: 100,
  payers: [{ virtual_account: '859b645a-ebb8-4f91-8b05-b433c85dc662', amount: 100 }],
  recipients: [
    { type: 'commission', number: 1, amount: 10, name: 'Комиссия' },
    { type: 'payment_contract', number: 2, amount: 90, account: '40702810901500016731', bank_code: '044525999', name: 'ООО "БУКАШКА"', inn: '6950211138' }
  ]
};

const validated = createDealParamsSchema.parse(data);
```
