# Задание 6: UI — Форма создания/редактирования сделки

## Контекст
Проект Cyclops Dashboard. Нужно создать форму для создания новой сделки и редактирования существующей.

## Входные данные
- Хуки: `hooks/useDeals.ts` (хуки `useCreateDeal`, `useDeal`)
- Валидаторы: `lib/validators/deals.ts`
- Типы: `types/cyclops/deals.ts`

## Задача
Создать страницы:
1. `app/(dashboard)/deals/create/page.tsx` — создание
2. `app/(dashboard)/deals/[dealId]/edit/page.tsx` — редактирование

## Структура формы

### 1. Основные данные
- **Внешний ключ** (ext_key) — текстовое поле, опционально
- **Общая сумма** — автовычисление из получателей (readonly)

### 2. Плательщики (динамический список)
Для каждого плательщика:
- **Виртуальный счёт** — Select с поиском (из API `list_virtual_accounts`)
- **Сумма** — число

Кнопки:
- "Добавить плательщика"
- "Удалить" (у каждого, если > 1)

### 3. Получатели (динамический список)
Для каждого получателя:
- **Тип** — Select (определяет набор полей)
- **Номер** — автоинкремент (readonly)
- **Сумма** — число
- Динамические поля по типу

Кнопки:
- "Добавить получателя"
- "Удалить" (у каждого)

### 4. Кнопки формы
- "Создать сделку" / "Сохранить изменения"
- "Отмена" → возврат к списку

## Поля по типам получателей

### payment_contract
```
Счёт (account)          — input, 20 цифр, обязательное
БИК (bank_code)         — input, 9 цифр, обязательное
Наименование (name)     — input, обязательное
ИНН (inn)               — input, 10 или 12 цифр, обязательное
КПП (kpp)               — input, 9 цифр, опционально
Назначение (purpose)    — textarea, опционально
НДС % (purpose_nds)     — number, опционально
```

### commission
```
Наименование (name)     — input, обязательное
Назначение (purpose)    — textarea, опционально
  ИЛИ
НДС % (purpose_nds)     — number
Тип назначения          — select (standard / with_inn)
```

### payment_contract_by_sbp / payment_contract_by_sbp_v2
```
Имя (first_name)        — input, обязательное
Отчество (middle_name)  — input, опционально
Фамилия (last_name)     — input, обязательное
Телефон (phone_number)  — input с маской +7 ___ ___ __ __, обязательное
Банк СБП (bank_sbp_id)  — select из list_bank_sbp, обязательное
Назначение (purpose)    — textarea, до 140 символов
НДС % (purpose_nds)     — number, опционально
ИНН (inn)               — input, 12 цифр, опционально
```

### payment_contract_to_card
```
Номер карты             — input с маской ____ ____ ____ ____, обязательное
                          (шифруется перед отправкой!)
Назначение (purpose)    — textarea, до 210 символов
ИНН (inn)               — input, 12 цифр, опционально
```

### ndfl_to_virtual_account
```
Виртуальный счёт        — select (тип for_ndfl), обязательное
```

## Валидация

### На клиенте (перед отправкой)
1. Сумма плательщиков = сумма получателей
2. Уникальность номеров получателей
3. Обязательные поля заполнены
4. Форматы полей:
   - Счёт: 20 цифр
   - БИК: 9 цифр
   - ИНН: 10 или 12 цифр
   - Телефон: 11 цифр, начинается с 7
   - Текстовые поля: regex `^[ -~№А-яёЁ\t\n\r]*$`

### После отправки
- Показать `compliance_check_payments`
- Если есть `approved: false` — предупреждение (можно продолжить)

## Реализация

### Компонент формы: `components/deals/DealForm.tsx`

```tsx
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import type { 
  CreateDealParams, 
  DealRecipient, 
  RecipientType,
  ComplianceCheckResult 
} from '@/types/cyclops/deals';
import { RECIPIENT_TYPE_LABELS, validateDealAmounts, generateRecipientNumber } from '@/lib/utils/deals';

// Типы получателей для выбора
const RECIPIENT_TYPES: { value: RecipientType; label: string }[] = [
  { value: 'payment_contract', label: 'Оплата по договору' },
  { value: 'commission', label: 'Комиссия' },
  { value: 'payment_contract_by_sbp_v2', label: 'СБП (по телефону)' },
  { value: 'payment_contract_to_card', label: 'На карту' },
  { value: 'ndfl_to_virtual_account', label: 'Сбор на налоги (ВС)' },
];

interface DealFormProps {
  initialData?: CreateDealParams;
  onSubmit: (data: CreateDealParams) => Promise<{ compliance_check_payments?: ComplianceCheckResult[] }>;
  submitLabel: string;
}

// Компонент поля плательщика
function PayerField({ 
  payer, 
  index, 
  onChange, 
  onRemove, 
  canRemove,
  virtualAccounts 
}: {
  payer: { virtual_account: string; amount: number };
  index: number;
  onChange: (index: number, payer: { virtual_account: string; amount: number }) => void;
  onRemove: (index: number) => void;
  canRemove: boolean;
  virtualAccounts: Array<{ id: string; balance: number }>;
}) {
  return (
    <div className="flex gap-4 items-end p-4 bg-gray-50 rounded-lg">
      <div className="flex-1">
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Виртуальный счёт
        </label>
        <select
          value={payer.virtual_account}
          onChange={(e) => onChange(index, { ...payer, virtual_account: e.target.value })}
          className="w-full border rounded-md px-3 py-2"
          required
        >
          <option value="">Выберите счёт</option>
          {virtualAccounts.map((va) => (
            <option key={va.id} value={va.id}>
              {va.id.slice(0, 8)}... (баланс: {va.balance.toLocaleString('ru-RU')} ₽)
            </option>
          ))}
        </select>
      </div>
      
      <div className="w-40">
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Сумма
        </label>
        <input
          type="number"
          step="0.01"
          min="0"
          value={payer.amount || ''}
          onChange={(e) => onChange(index, { ...payer, amount: parseFloat(e.target.value) || 0 })}
          className="w-full border rounded-md px-3 py-2"
          required
        />
      </div>
      
      {canRemove && (
        <button
          type="button"
          onClick={() => onRemove(index)}
          className="px-3 py-2 text-red-600 hover:bg-red-50 rounded-md"
        >
          Удалить
        </button>
      )}
    </div>
  );
}

// Компонент полей получателя payment_contract
function PaymentContractFields({ 
  recipient, 
  onChange 
}: { 
  recipient: any; 
  onChange: (updates: Partial<any>) => void;
}) {
  return (
    <>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Счёт получателя *
          </label>
          <input
            type="text"
            value={recipient.account || ''}
            onChange={(e) => onChange({ account: e.target.value.replace(/\D/g, '').slice(0, 20) })}
            placeholder="20 цифр"
            maxLength={20}
            className="w-full border rounded-md px-3 py-2 font-mono"
            required
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            БИК *
          </label>
          <input
            type="text"
            value={recipient.bank_code || ''}
            onChange={(e) => onChange({ bank_code: e.target.value.replace(/\D/g, '').slice(0, 9) })}
            placeholder="9 цифр"
            maxLength={9}
            className="w-full border rounded-md px-3 py-2 font-mono"
            required
          />
        </div>
      </div>
      
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Наименование получателя *
        </label>
        <input
          type="text"
          value={recipient.name || ''}
          onChange={(e) => onChange({ name: e.target.value })}
          className="w-full border rounded-md px-3 py-2"
          required
        />
      </div>
      
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            ИНН *
          </label>
          <input
            type="text"
            value={recipient.inn || ''}
            onChange={(e) => onChange({ inn: e.target.value.replace(/\D/g, '').slice(0, 12) })}
            placeholder="10 или 12 цифр"
            maxLength={12}
            className="w-full border rounded-md px-3 py-2 font-mono"
            required
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            КПП
          </label>
          <input
            type="text"
            value={recipient.kpp || ''}
            onChange={(e) => onChange({ kpp: e.target.value.replace(/\D/g, '').slice(0, 9) })}
            placeholder="9 цифр"
            maxLength={9}
            className="w-full border rounded-md px-3 py-2 font-mono"
          />
        </div>
      </div>
      
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Назначение платежа
        </label>
        <textarea
          value={recipient.purpose || ''}
          onChange={(e) => onChange({ purpose: e.target.value })}
          rows={2}
          className="w-full border rounded-md px-3 py-2"
        />
      </div>
      
      <div className="w-32">
        <label className="block text-sm font-medium text-gray-700 mb-1">
          НДС %
        </label>
        <input
          type="number"
          value={recipient.purpose_nds || ''}
          onChange={(e) => onChange({ purpose_nds: parseFloat(e.target.value) || undefined })}
          placeholder="0"
          className="w-full border rounded-md px-3 py-2"
        />
      </div>
    </>
  );
}

// Компонент полей получателя commission
function CommissionFields({ 
  recipient, 
  onChange 
}: { 
  recipient: any; 
  onChange: (updates: Partial<any>) => void;
}) {
  const [useCustomPurpose, setUseCustomPurpose] = useState(!!recipient.purpose);

  return (
    <>
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Наименование *
        </label>
        <input
          type="text"
          value={recipient.name || ''}
          onChange={(e) => onChange({ name: e.target.value })}
          className="w-full border rounded-md px-3 py-2"
          required
        />
      </div>
      
      <div className="flex items-center gap-2 mb-2">
        <input
          type="checkbox"
          id="customPurpose"
          checked={useCustomPurpose}
          onChange={(e) => {
            setUseCustomPurpose(e.target.checked);
            if (!e.target.checked) {
              onChange({ purpose: undefined });
            }
          }}
        />
        <label htmlFor="customPurpose" className="text-sm">
          Указать своё назначение платежа
        </label>
      </div>
      
      {useCustomPurpose ? (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Назначение платежа
          </label>
          <textarea
            value={recipient.purpose || ''}
            onChange={(e) => onChange({ purpose: e.target.value })}
            rows={2}
            className="w-full border rounded-md px-3 py-2"
            placeholder="Укажите назначение с информацией о НДС"
          />
        </div>
      ) : (
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              НДС %
            </label>
            <input
              type="number"
              value={recipient.purpose_nds || ''}
              onChange={(e) => onChange({ purpose_nds: parseFloat(e.target.value) || undefined })}
              className="w-full border rounded-md px-3 py-2"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Тип назначения
            </label>
            <select
              value={recipient.purpose_type || 'standard'}
              onChange={(e) => onChange({ purpose_type: e.target.value })}
              className="w-full border rounded-md px-3 py-2"
            >
              <option value="standard">Стандартное</option>
              <option value="with_inn">С ИНН плательщика</option>
            </select>
          </div>
        </div>
      )}
    </>
  );
}

// Компонент полей получателя СБП
function SbpFields({ 
  recipient, 
  onChange,
  sbpBanks 
}: { 
  recipient: any; 
  onChange: (updates: Partial<any>) => void;
  sbpBanks: Array<{ id: string; name: string }>;
}) {
  const formatPhone = (value: string) => {
    const digits = value.replace(/\D/g, '');
    if (digits.length === 0) return '';
    if (digits[0] !== '7') return '7' + digits.slice(0, 10);
    return digits.slice(0, 11);
  };

  return (
    <>
      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Фамилия *
          </label>
          <input
            type="text"
            value={recipient.last_name || ''}
            onChange={(e) => onChange({ last_name: e.target.value })}
            className="w-full border rounded-md px-3 py-2"
            required
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Имя *
          </label>
          <input
            type="text"
            value={recipient.first_name || ''}
            onChange={(e) => onChange({ first_name: e.target.value })}
            className="w-full border rounded-md px-3 py-2"
            required
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Отчество
          </label>
          <input
            type="text"
            value={recipient.middle_name || ''}
            onChange={(e) => onChange({ middle_name: e.target.value })}
            className="w-full border rounded-md px-3 py-2"
          />
        </div>
      </div>
      
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Телефон *
          </label>
          <input
            type="text"
            value={recipient.phone_number || ''}
            onChange={(e) => onChange({ phone_number: formatPhone(e.target.value) })}
            placeholder="79001234567"
            className="w-full border rounded-md px-3 py-2 font-mono"
            required
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Банк СБП *
          </label>
          <select
            value={recipient.bank_sbp_id || ''}
            onChange={(e) => onChange({ bank_sbp_id: e.target.value })}
            className="w-full border rounded-md px-3 py-2"
            required
          >
            <option value="">Выберите банк</option>
            {sbpBanks.map((bank) => (
              <option key={bank.id} value={bank.id}>{bank.name}</option>
            ))}
          </select>
        </div>
      </div>
      
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Назначение платежа (до 140 символов)
        </label>
        <textarea
          value={recipient.purpose || ''}
          onChange={(e) => onChange({ purpose: e.target.value.slice(0, 140) })}
          maxLength={140}
          rows={2}
          className="w-full border rounded-md px-3 py-2"
        />
      </div>
    </>
  );
}

// Компонент полей получателя на карту
function CardFields({ 
  recipient, 
  onChange 
}: { 
  recipient: any; 
  onChange: (updates: Partial<any>) => void;
}) {
  const [cardNumber, setCardNumber] = useState('');

  const formatCard = (value: string) => {
    return value.replace(/\D/g, '').slice(0, 16);
  };

  // При изменении номера карты — сохраняем (шифрование будет при отправке)
  useEffect(() => {
    onChange({ _card_number_plain: cardNumber });
  }, [cardNumber]);

  return (
    <>
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Номер карты *
        </label>
        <input
          type="text"
          value={cardNumber}
          onChange={(e) => setCardNumber(formatCard(e.target.value))}
          placeholder="0000 0000 0000 0000"
          maxLength={16}
          className="w-full border rounded-md px-3 py-2 font-mono"
          required
        />
        <p className="text-xs text-gray-500 mt-1">
          Номер карты будет зашифрован перед отправкой
        </p>
      </div>
      
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Назначение платежа (до 210 символов)
        </label>
        <textarea
          value={recipient.purpose || ''}
          onChange={(e) => onChange({ purpose: e.target.value.slice(0, 210) })}
          maxLength={210}
          rows={2}
          className="w-full border rounded-md px-3 py-2"
        />
      </div>
    </>
  );
}

// Компонент поля получателя
function RecipientField({ 
  recipient, 
  index, 
  onChange, 
  onRemove,
  sbpBanks,
  virtualAccountsForNdfl
}: {
  recipient: DealRecipient & { _card_number_plain?: string };
  index: number;
  onChange: (index: number, recipient: any) => void;
  onRemove: (index: number) => void;
  sbpBanks: Array<{ id: string; name: string }>;
  virtualAccountsForNdfl: Array<{ id: string }>;
}) {
  const handleTypeChange = (newType: RecipientType) => {
    // Сбрасываем поля при смене типа, сохраняем number и amount
    onChange(index, { 
      type: newType, 
      number: recipient.number, 
      amount: recipient.amount 
    });
  };

  const handleFieldChange = (updates: Partial<any>) => {
    onChange(index, { ...recipient, ...updates });
  };

  return (
    <div className="p-4 bg-gray-50 rounded-lg space-y-4">
      <div className="flex justify-between items-center">
        <span className="font-medium">Получатель #{recipient.number}</span>
        <button
          type="button"
          onClick={() => onRemove(index)}
          className="text-red-600 hover:bg-red-50 px-2 py-1 rounded"
        >
          Удалить
        </button>
      </div>
      
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Тип получателя *
          </label>
          <select
            value={recipient.type}
            onChange={(e) => handleTypeChange(e.target.value as RecipientType)}
            className="w-full border rounded-md px-3 py-2"
            required
          >
            {RECIPIENT_TYPES.map((rt) => (
              <option key={rt.value} value={rt.value}>{rt.label}</option>
            ))}
          </select>
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Сумма *
          </label>
          <input
            type="number"
            step="0.01"
            min="0"
            value={recipient.amount || ''}
            onChange={(e) => handleFieldChange({ amount: parseFloat(e.target.value) || 0 })}
            className="w-full border rounded-md px-3 py-2"
            required
          />
        </div>
      </div>
      
      {/* Поля в зависимости от типа */}
      {recipient.type === 'payment_contract' && (
        <PaymentContractFields recipient={recipient} onChange={handleFieldChange} />
      )}
      
      {recipient.type === 'commission' && (
        <CommissionFields recipient={recipient} onChange={handleFieldChange} />
      )}
      
      {(recipient.type === 'payment_contract_by_sbp' || recipient.type === 'payment_contract_by_sbp_v2') && (
        <SbpFields recipient={recipient} onChange={handleFieldChange} sbpBanks={sbpBanks} />
      )}
      
      {recipient.type === 'payment_contract_to_card' && (
        <CardFields recipient={recipient} onChange={handleFieldChange} />
      )}
      
      {recipient.type === 'ndfl_to_virtual_account' && (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Виртуальный счёт (for_ndfl) *
          </label>
          <select
            value={(recipient as any).virtual_account || ''}
            onChange={(e) => handleFieldChange({ virtual_account: e.target.value })}
            className="w-full border rounded-md px-3 py-2"
            required
          >
            <option value="">Выберите счёт</option>
            {virtualAccountsForNdfl.map((va) => (
              <option key={va.id} value={va.id}>{va.id}</option>
            ))}
          </select>
        </div>
      )}
    </div>
  );
}

// Основной компонент формы
export function DealForm({ initialData, onSubmit, submitLabel }: DealFormProps) {
  const router = useRouter();
  
  const [extKey, setExtKey] = useState(initialData?.ext_key || '');
  const [payers, setPayers] = useState(initialData?.payers || [{ virtual_account: '', amount: 0 }]);
  const [recipients, setRecipients] = useState<any[]>(
    initialData?.recipients || [{ type: 'payment_contract', number: 1, amount: 0 }]
  );
  
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [complianceWarning, setComplianceWarning] = useState<ComplianceCheckResult[] | null>(null);
  
  // Данные для селектов (загрузить из API)
  const [virtualAccounts, setVirtualAccounts] = useState<Array<{ id: string; balance: number }>>([]);
  const [sbpBanks, setSbpBanks] = useState<Array<{ id: string; name: string }>>([]);
  const [virtualAccountsForNdfl, setVirtualAccountsForNdfl] = useState<Array<{ id: string }>>([]);
  
  // TODO: Загрузить данные при монтировании
  useEffect(() => {
    // fetch('/api/virtual-accounts?type=standard').then(...)
    // fetch('/api/sbp-banks').then(...)
    // fetch('/api/virtual-accounts?type=for_ndfl').then(...)
  }, []);

  // Автовычисление суммы
  const totalAmount = useMemo(() => {
    return recipients.reduce((sum, r) => sum + (r.amount || 0), 0);
  }, [recipients]);

  const payersTotal = useMemo(() => {
    return payers.reduce((sum, p) => sum + (p.amount || 0), 0);
  }, [payers]);

  // Добавление плательщика
  const addPayer = () => {
    setPayers([...payers, { virtual_account: '', amount: 0 }]);
  };

  // Удаление плательщика
  const removePayer = (index: number) => {
    setPayers(payers.filter((_, i) => i !== index));
  };

  // Изменение плательщика
  const updatePayer = (index: number, payer: { virtual_account: string; amount: number }) => {
    const updated = [...payers];
    updated[index] = payer;
    setPayers(updated);
  };

  // Добавление получателя
  const addRecipient = () => {
    const existingNumbers = recipients.map(r => r.number);
    const newNumber = generateRecipientNumber(existingNumbers);
    setRecipients([...recipients, { type: 'payment_contract', number: newNumber, amount: 0 }]);
  };

  // Удаление получателя
  const removeRecipient = (index: number) => {
    setRecipients(recipients.filter((_, i) => i !== index));
  };

  // Изменение получателя
  const updateRecipient = (index: number, recipient: any) => {
    const updated = [...recipients];
    updated[index] = recipient;
    setRecipients(updated);
  };

  // Отправка формы
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setComplianceWarning(null);
    
    // Валидация сумм
    const validation = validateDealAmounts(totalAmount, payers, recipients);
    if (!validation.valid) {
      setError(validation.error!);
      return;
    }
    
    // Подготовка данных
    const data: CreateDealParams = {
      amount: totalAmount,
      payers: payers.map(p => ({
        virtual_account: p.virtual_account,
        amount: p.amount,
      })),
      recipients: recipients.map(r => {
        const { _card_number_plain, ...rest } = r;
        
        // Если карта — нужно зашифровать
        if (r.type === 'payment_contract_to_card' && _card_number_plain) {
          // TODO: Вызвать API шифрования
          // rest.card_number_crypto_base64 = await encryptCard(_card_number_plain);
        }
        
        return rest;
      }),
    };
    
    if (extKey) {
      data.ext_key = extKey;
    }
    
    setLoading(true);
    
    try {
      const result = await onSubmit(data);
      
      // Проверяем compliance
      if (result.compliance_check_payments) {
        const hasErrors = result.compliance_check_payments.some(c => !c.approved);
        if (hasErrors) {
          setComplianceWarning(result.compliance_check_payments);
          // Не перенаправляем, даём пользователю решить
          return;
        }
      }
      
      // Успех — перенаправляем
      router.push('/deals');
    } catch (e) {
      setError(e instanceof Error ? e.message : 'Ошибка сохранения');
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Ошибка */}
      {error && (
        <div className="bg-red-50 text-red-600 p-4 rounded-lg">
          {error}
        </div>
      )}
      
      {/* Предупреждение комплаенс */}
      {complianceWarning && (
        <div className="bg-yellow-50 p-4 rounded-lg">
          <h3 className="font-semibold text-yellow-800 mb-2">
            Предупреждение комплаенс-службы
          </h3>
          {complianceWarning.filter(c => !c.approved).map((c) => (
            <div key={c.number} className="mb-2">
              <p className="font-medium">Получатель #{c.number}:</p>
              {c.messages.map((m, i) => (
                <p key={i} className="text-sm text-yellow-700">
                  [{m.level}] {m.text}
                </p>
              ))}
            </div>
          ))}
          <p className="text-sm mt-2">Вы можете продолжить, но платёж может быть отклонён.</p>
        </div>
      )}
      
      {/* Основные данные */}
      <div className="bg-white p-6 rounded-lg shadow">
        <h2 className="text-lg font-semibold mb-4">Основные данные</h2>
        
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Внешний ключ (ext_key)
            </label>
            <input
              type="text"
              value={extKey}
              onChange={(e) => setExtKey(e.target.value)}
              placeholder="Опционально"
              className="w-full border rounded-md px-3 py-2"
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Общая сумма
            </label>
            <input
              type="text"
              value={totalAmount.toLocaleString('ru-RU', { minimumFractionDigits: 2 }) + ' ₽'}
              readOnly
              className="w-full border rounded-md px-3 py-2 bg-gray-100"
            />
            {Math.abs(payersTotal - totalAmount) > 0.01 && (
              <p className="text-sm text-red-600 mt-1">
                Сумма плательщиков ({payersTotal.toFixed(2)}) ≠ сумме получателей
              </p>
            )}
          </div>
        </div>
      </div>
      
      {/* Плательщики */}
      <div className="bg-white p-6 rounded-lg shadow">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-lg font-semibold">Плательщики</h2>
          <button
            type="button"
            onClick={addPayer}
            className="px-3 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200"
          >
            + Добавить
          </button>
        </div>
        
        <div className="space-y-4">
          {payers.map((payer, index) => (
            <PayerField
              key={index}
              payer={payer}
              index={index}
              onChange={updatePayer}
              onRemove={removePayer}
              canRemove={payers.length > 1}
              virtualAccounts={virtualAccounts}
            />
          ))}
        </div>
      </div>
      
      {/* Получатели */}
      <div className="bg-white p-6 rounded-lg shadow">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-lg font-semibold">Получатели</h2>
          <button
            type="button"
            onClick={addRecipient}
            className="px-3 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200"
          >
            + Добавить
          </button>
        </div>
        
        <div className="space-y-4">
          {recipients.map((recipient, index) => (
            <RecipientField
              key={recipient.number}
              recipient={recipient}
              index={index}
              onChange={updateRecipient}
              onRemove={removeRecipient}
              sbpBanks={sbpBanks}
              virtualAccountsForNdfl={virtualAccountsForNdfl}
            />
          ))}
        </div>
      </div>
      
      {/* Кнопки */}
      <div className="flex gap-4">
        <button
          type="submit"
          disabled={loading}
          className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50"
        >
          {loading ? 'Сохранение...' : submitLabel}
        </button>
        
        <button
          type="button"
          onClick={() => router.push('/deals')}
          className="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"
        >
          Отмена
        </button>
      </div>
    </form>
  );
}
```

### Страница создания: `app/(dashboard)/deals/create/page.tsx`

```tsx
'use client';

import { useCreateDeal } from '@/hooks/useDeals';
import { DealForm } from '@/components/deals/DealForm';

export default function CreateDealPage() {
  const { createDeal } = useCreateDeal();

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-6">Создание сделки</h1>
      <DealForm 
        onSubmit={createDeal}
        submitLabel="Создать сделку"
      />
    </div>
  );
}
```

### Страница редактирования: `app/(dashboard)/deals/[dealId]/edit/page.tsx`

```tsx
'use client';

import { useEffect, useState } from 'react';
import { useDeal } from '@/hooks/useDeals';
import { DealForm } from '@/components/deals/DealForm';
import type { CreateDealParams } from '@/types/cyclops/deals';

export default function EditDealPage({ params }: { params: { dealId: string } }) {
  const { deal, loading, error, updateDeal } = useDeal(params.dealId);
  const [initialData, setInitialData] = useState<CreateDealParams | null>(null);

  useEffect(() => {
    if (deal) {
      // Преобразуем данные сделки в формат формы
      setInitialData({
        ext_key: deal.ext_key,
        amount: deal.amount,
        payers: deal.payers.map(p => ({
          virtual_account: p.virtual_account,
          amount: p.amount,
        })),
        recipients: deal.recipients.map(r => ({
          ...r.requisites,
          type: r.type,
          number: r.number,
          amount: r.amount,
        })),
      });
    }
  }, [deal]);

  if (loading) {
    return <div className="p-6">Загрузка...</div>;
  }

  if (error || !deal) {
    return <div className="p-6 text-red-600">{error || 'Сделка не найдена'}</div>;
  }

  if (!initialData) {
    return <div className="p-6">Подготовка формы...</div>;
  }

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-6">Редактирование сделки</h1>
      <DealForm 
        initialData={initialData}
        onSubmit={updateDeal}
        submitLabel="Сохранить изменения"
      />
    </div>
  );
}
```

## Ожидаемый результат

Созданные файлы:
- `components/deals/DealForm.tsx` — универсальный компонент формы
- `app/(dashboard)/deals/create/page.tsx` — страница создания
- `app/(dashboard)/deals/[dealId]/edit/page.tsx` — страница редактирования

## Дополнительно

Для полноценной работы формы нужно:
1. Реализовать API `/api/sbp-banks` для списка банков СБП (`list_bank_sbp`)
2. Реализовать API шифрования номера карты (`/api/encrypt-card`)
3. Загружать виртуальные счета разных типов
